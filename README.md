### Отчет о тестировании поведения распределения виртуальной и физической памяти

Проверяем влияния различных режимов доступа (чтение/запись) на занимаемый объем физической памяти при распределении памяти с использованием функции `malloc()`. Тестирование проводилось в сравнительном режиме: в среде Linux и в имитационной среде Windows, запущенной через Wine.

#### Аппаратная среда

- CPU: Intel(R) Core(TM) i7-1065G7 CPU @ 1.30GHz
- memory: 16GiB

#### Шаги 
1. Запускать программу соответственно в режимах `r` (чтение) и `w` (запись)
2. Наблюдать за состоянием использования памяти в инструменте мониторинга системы
3. Записывать изменения физической памяти и виртуальной памяти
4. Приостанавливать процесс после каждого распределения 128 MiB памяти и фиксировать полученные результаты наблюдения

- **Размер страницы**: 4 КБ 
- **Шаг распределения**: 128 МБ
- **Настройка задержки**: 100 микросекунд на доступ к странице
- **Максимальное распределение**: 4 ГБ 

#### Результаты тестирования системы Linux
>  Ubuntu 24.04.1 LTS

Напишем shell-скрипт для отслеживания изменений в виртуальной и физической памяти в режиме реального времени!!([monitor.sh](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/monitor.sh))

##### Read

Запустить нашу программу после запуска скрипта

```shell
 ./monitor.sh
```

```shell
./memory_test r
```

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/1.png?raw=true)

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/2.png?raw=true)

##### Write

```shell
 ./monitor.sh
```

```shell
./memory_test w
```

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/5.png?raw=true)

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/3.png?raw=true)

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/4.png?raw=true)

#### Результаты тестирования системы Windows через Wine

> Windows 10

Точно так же напишем shell-скрипт для отслеживания изменений в виртуальной и физической памяти в режиме реального времени!!([wine_monitor.sh](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/wine_monitor.sh))

##### Read

Компиляция исполняемых файлов Windows в Linux:

```shell
 x86_64-w64-mingw32-gcc -o memory_test.exe memory_test.c
```

Запустить нашу программу после запуска скрипта

```shell
./wine_monitor.sh
```

```shell
 wine ./memory_test.exe r
```

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/7.png?raw=true)

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/6.png?raw=true)

Программа работает очень медленно в системе Windows, эмулируемой через Wine

##### Write

```shell
./wine_monitor.sh
```

```shell
 wine ./memory_test.exe w
```

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/8.png?raw=true)

![](https://github.com/xiangxiang3451/virtual-physical-memory/blob/main/images/9.png?raw=true)

#### Вывод 

##### 1. **Поведение в среде Linux**

- Режим `r`:Виртуальная память растет согласно ожиданиям (на 128 MiB каждый раз), но физическая память практически не изменяется. Причина: в Linux функция `malloc` только предварительно выделяет виртуальное адресное пространство, но не выполняет фактическое отображение физической памяти; операция «чтения неинициализированной памяти» не запускает распределение физической памяти.
- Режим `w`  :Виртуальная память также продолжает расти на 128 MiB, однако физическая память постепенно увеличивается вместе с операциями записи.

##### 2. **Поведение в эмулированной среде Windows (через Wine)**

- Режимы `r`/`w` :

  Виртуальная память также увеличивается с шагом +128 МиБ, но потребление физической памяти более «агрессивное» по сравнению с нативным Linux — даже в режиме r физическая память незначительно растёт. 

  Причина: особенности логики эмуляции модели памяти Windows в Wine или более строгая обработка операций «доступа к неинициализированной памяти» самой Windows (даже операция чтения может запустить отображение физической памяти).


##### 3. Итоги:

- Виртуальная память : независимо от режима (чтение/запись) и среды, `malloc` немедленно выделяет виртуальное адресное пространство.
- Физическая память : операционная система распределяет физические страницы только тогда, когда программа фактически записывает данные в память; при единственном «чтении неинициализированной памяти» физическая память практически не растет.
- Wine vs Linux : в Wine потребление физической памяти выражено более явно, что отражает различия в стратегиях отображения памяти между различными операционными системами/эмуляционными слоями.